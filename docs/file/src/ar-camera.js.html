<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/ar-camera.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/ar-camera.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// Register AR component
AFRAME.registerComponent(&apos;ar-camera&apos;, {
    schema: { elid: { type: &apos;string&apos; }, cameraid: { type: &apos;string&apos; } },
    init: function () {
        window.ARcamera = {};

        if (this.data.cameraid != &apos;&apos;) {
            window.ARcamera.camera = document.getElementById(this.data.cameraid);
        } else {
            window.ARcamera.camera = document.querySelector(&apos;a-camera&apos;);
        }

        window.ARcamera.video_component = this.el;
        window.ARcamera.canvas = document.createElement(&apos;canvas&apos;);

        window.ARcamera.el_obj = document.getElementById(this.data.elid);

        window.ARcamera.detector = new AR.Detector();

        window.ARcamera.size_real = 95;

        window.ARcamera.timeDelta = 0;
    },
    update: function (oldData) {
        if (oldData.elid !== this.data.elid) {
            window.ARcamera.el_obj = document.getElementById(this.data.elid);
        }
        if (oldData.cameraid !== this.data.cameraid) {
            if (this.data.cameraid != &apos;&apos;) {
                window.ARcamera.camera = document.getElementById(this.data.cameraid);
            } else {
                window.ARcamera.camera = document.querySelector(&apos;a-camera&apos;);
            }
        }
    },
    tick: function (time, timeDelta) {
        window.ARcamera.timeDelta += timeDelta;
        if (window.ARcamera.timeDelta &lt; 60) {
            return;
        }
        window.ARcamera.timeDelta = 0;
        if (typeof window.ARcamera.video == &apos;undefined&apos;) {
            if (window.ARcamera.video_component.getAttribute(&apos;src&apos;) != null) {
                //TODO: can i detect the video id generated by a-video-billboard ?? I can generalize the component here
                window.ARcamera.video = document.getElementById(window.ARcamera.video_component.getAttribute(&apos;src&apos;).substr(1));
                window.ARcamera.canvas.width = window.ARcamera.video.videoWidth;
                window.ARcamera.canvas.height = window.ARcamera.video.videoHeight;
                window.ARcamera.context = window.ARcamera.canvas.getContext(&apos;2d&apos;);

                window.ARcamera.view_width = window.ARcamera.video_component.getAttribute(&apos;width&apos;),
                    window.ARcamera.view_heigth = window.ARcamera.video_component.getAttribute(&apos;height&apos;);
                window.ARcamera.view_depth = window.ARcamera.video_component.getAttribute(&apos;frustum-lock&apos;).depth;
            }
        } else {
            window.ARcamera.context.drawImage(window.ARcamera.video, 0, 0, window.ARcamera.video.videoWidth, window.ARcamera.video.videoHeight);
            var imageData = window.ARcamera.context.getImageData(0, 0, window.ARcamera.canvas.width, window.ARcamera.canvas.height);

            var markers = window.ARcamera.detector.detect(imageData);

            if (markers.length &gt; 0) {
                var points = markers[0].corners;

                var position = calcIntersection(generateLine(points[0], points[2]), generateLine(points[1], points[3]));

                // Marker &quot;only&quot; x rotated
                if (Math.abs(calcAngle(points[0], points[1])) &lt; Math.PI / 8 &amp;&amp; Math.abs(calcAngle(points[2], points[3])) &lt; Math.PI / 8) {
                    line_near = calcMax(generateLine(points[0], points[1]), generateLine(points[2], points[3]));
                    line_far = calcMin(generateLine(points[0], points[1]), generateLine(points[2], points[3]));
                    line_side1 = generateLine(points[1], points[2]);
                    line_side2 = generateLine(points[3], points[0]);
                    // Marker &quot;only&quot; x rotated
                } else if (Math.abs(calcAngle(points[1], points[2])) &lt; Math.PI / 8 &amp;&amp; Math.abs(calcAngle(points[3], points[0])) &lt; Math.PI / 8) {
                    line_near = calcMax(generateLine(points[1], points[2]), generateLine(points[3], points[0]));
                    line_far = calcMin(generateLine(points[1], points[2]), generateLine(points[3], points[0]));
                    line_side1 = generateLine(points[0], points[1]);
                    line_side2 = generateLine(points[2], points[3]);
                } else { // TODO: other cases. e: 
                    line_near = generateLine(points[1], points[2]);
                    line_far = generateLine(points[3], points[0]);
                    line_side1 = generateLine(points[0], points[1]);
                    line_side2 = generateLine(points[2], points[3]);
                }
                line_final = line_near;// TODO: parallel line_near in point position insersect with line_side1,line_side2

                line_far_size = calcSize(line_far);
                line_near_size = calcSize(line_near);
                line_final_size = calcSize(line_final);
                x_final = (position.x * window.ARcamera.view_width / window.ARcamera.canvas.width) - window.ARcamera.view_width * .5;
                y_final = (position.y * window.ARcamera.view_heigth / window.ARcamera.canvas.height) - window.ARcamera.view_heigth * .5;
                z_final = window.ARcamera.size_real / line_final_size;

                // Distance correction
                ly_final = Math.atan(y_final / window.ARcamera.view_depth);
                y_final = z_final * Math.tan(ly_final);

                lx_final = Math.atan(x_final / window.ARcamera.view_depth);
                x_final = z_final * Math.tan(lx_final);


                /*
                lx_rota_size = calcDistance(getPoints(line_near)[0],getPoints(line_far)[0]);
                lx_rotb_size = (line_near_size-line_far_size)/2;
                lx_rot = Math.asin(lx_rotb_size/lx_rota_size);
                x_rot = 20*180*lx_rot/Math.PI;
                */
                /*
                x_rota_size = (window.ARcamera.size_real/line_far_size) - (window.ARcamera.size_real/line_near_size);
                x_rotb_size = 0.04;
                lx_rot = Math.acos(x_rota_size/x_rotb_size);
                x_rot = 180*lx_rot/Math.PI;
                */
                z_rot = 180 * calcAngle(getPoints(line_final)[0], getPoints(line_final)[1]) / Math.PI;


                var pos_cam = window.ARcamera.camera.getAttribute(&apos;position&apos;);
                var rot_cam = window.ARcamera.camera.getAttribute(&apos;rotation&apos;);

                // Set position and rotation values
                var pos = window.ARcamera.el_obj.getAttribute(&apos;position&apos;);
                var rot = window.ARcamera.el_obj.getAttribute(&apos;rotation&apos;);
                pos.x = pos_cam.x - x_final;
                pos.y = pos_cam.y - y_final;
                pos.z = pos_cam.z - z_final;

                //rot.x = -x_rot;
                //rot.y = -y_rot;
                rot.z = z_rot;


                window.ARcamera.el_obj.setAttribute(&apos;position&apos;, pos);
                window.ARcamera.el_obj.setAttribute(&apos;rotation&apos;, rot);
            }
        }
    }
});</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
